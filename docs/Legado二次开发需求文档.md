# Legado (阅读) 二次开发需求文档：WebDAV 书籍无缝漫游

## 1. 项目背景与目标

### 背景：
当前 Legado 用户在通过云端备份恢复数据到新设备后，对于“本地书籍”类型的条目，由于本地存储路径变化或文件尚未传输到新设备，点击阅读时会提示“文件不存在”或要求重新选择路径。用户手动下载或重新映射路径极其繁琐。

### 目标：
- **无感阅读**：点击任意分组下的本地书籍，若本地文件缺失，自动从 WebDAV 查找并下载，无需用户干预。
- **云端书库**：增加“远程书籍”默认分组，直观展示 WebDAV 上的书籍列表，支持下拉刷新与点击下载阅读。

## 2. 核心功能需求

### 2.1 功能模块一：全局书籍智能打开逻辑 (Smart Open)

这是本项目的核心逻辑，需拦截所有“打开书籍”的事件。

**当前逻辑：**
- 检查 `book.bookUrl` (本地路径) → 存在 → 打开阅读
- 检查 `book.bookUrl` (本地路径) → 不存在 → 弹窗提示错误/重选

**新逻辑 (修改后)：**
当用户在任意分组点击书籍阅读时：

**Step 1: 本地检查**
- 检查数据库中记录的本地路径是否存在文件
- 如果存在 → 直接打开阅读 (保持原逻辑)
- 如果不存在 → 进入 Step 2

**Step 2: WebDAV 匹配检查**
- 根据书籍的文件名 (例如 `书名.txt` 或 `书名.epub`)，在配置的 WebDAV 存储目录下检索是否存在同名文件

**Step 3: 自动化处理**

**场景 A：WebDAV 上存在该书**
- UI 显示加载/下载进度条 (Toast 或 弹窗)
- 后台将文件从 WebDAV 下载到用户设定的默认本地书籍存储目录
- 下载完成后，更新数据库中该书的 `bookUrl` 为新的本地路径
- 自动打开书籍，恢复阅读进度

**场景 B：WebDAV 上也不存在**
- 执行原有逻辑 (提示文件丢失，弹出文件选择器让用户手动查找)

### 2.2 功能模块二：新增“远程书籍”分组 (Remote Group)

在书架页新增或内置一个名为“远程书籍” (或 WebDAV 书籍) 的特殊分组/书源。

**展示逻辑：**
- 该分组的数据源并非直接来自本地数据库的 `books` 表，而是实时(或缓存)读取 WebDAV 指定目录下的文件列表
- 下拉刷新：用户在该分组顶部下拉，触发 WebDAV 目录扫描，刷新文件列表

**列表状态标识：**
- UI 上应区分“已下载”和“未下载”状态（右下角有一个云朵图标）
    - 已下载：本地存在该文件，且数据库已有记录
    - 未下载：仅在 WebDAV 上存在

**点击交互：**
- 若已导入且已下载：直接打开阅读
- 若未导入/未下载：点击后触发下载 → 自动导入数据库 → 打开阅读

### 2.3 交互逻辑核心：长按书籍 (Long Press Interaction)

**场景定义：**
用户在“远程书籍”列表中长按某一项（WebDAV 上的文件）。系统需根据该文件是否已在本地数据库（书单）中建立了索引，分两种情况处理。

**详细处理逻辑：**

**情况一：WebDAV 存在文件且书单已有记录 (Scenario: Linked)**
- **判定条件**：WebDAV 文件名与本地书籍数据 json 的 `originName` 字段匹配
- **执行动作**：
    - 无网络请求：完全不需要访问网络或下载文件
    - 直接跳转：利用数据库中缓存的封面、作者、简介等元数据，直接启动书籍详情页
    - 体验：秒开，与本地书架长按体验一致

**情况二：WebDAV 存在文件但书单无记录 (Scenario: Unlinked / New)**
- **判定条件**：遍历本地书籍数据，未找到与该文件名匹配的书籍记录
- **业务痛点**：WebDAV 上只有文件（如 `abc.txt`），没有书籍的元数据（封面、作者、简介）。Legado 想要显示详情页，必须先解析文件内容
- **执行动作**：
    - 提示反馈：弹出非模态加载框（Loading Dialog），提示文案：“正在下载并解析书籍详情...”
    - 静默下载：后台调用 WebDAV 接口将该文件下载到本地临时目录或默认书籍存储目录
    - 智能导入：调用 Legado 现有的逻辑：
        - 解析文件格式 (txt/epub/mobi)
        - 提取元数据（书名、作者、简介、封面图片）
        - 关键步骤：将生成的 Book 对象插入数据库
    - 状态更新：刷新当前列表，将该书状态标记为“已下载/已在书架”
    - 跳转：解析完成后，自动关闭 Loading 框，并携带新生成的 `bookUrl` 跳转至 `BookDetailActivity`

## 4. UI/UX 细节需求

**下载提示：**
- 由于下载书籍可能耗时（几MB到几十MB），必须展示非模态加载框或通知栏进度，不要完全阻塞界面
- 如果在“打开阅读”的场景下，建议使用带进度的 Dialog，用户可取消

**远程分组 UI：**
- 参考现有 UI，不要破坏风格一致性

## 6. 开发注意事项

1. 本次开发属于个性化需求，尽量不要删改原有代码，修改内容统一放到 `cust` 包下
2. 本次开发里大部分功能 legado 已经实现，复用现有逻辑不要自行实现